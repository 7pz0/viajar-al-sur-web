<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Registro - Viajar al Sur</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: 50px auto;
      padding: 20px;
    }
    
    input, button {
      padding: 10px;
      margin: 5px 0;
      width: 100%;
      box-sizing: border-box;
    }
    
    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
    }
    
    button:hover {
      background-color: #45a049;
    }
    
    #preview {
      margin: 10px 0;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    
    #status {
      margin-top: 20px;
      padding: 10px;
      border-radius: 5px;
    }
    
    .success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .loading {
      background-color: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
  </style>
</head>
<body>
  <h2>Registro con Imagen - Viajar al Sur V0.2</h2>

  <!-- Formulario para nombre, email y archivo -->
  <form id="myForm">
    <input type="text" id="name" placeholder="Tu nombre" required><br>
    <input type="email" id="email" placeholder="Tu email" required><br>
    <input type="file" id="image" accept="image/*" required><br>
    <!-- Previsualización de la imagen -->
    <img id="preview" src="" alt="Vista previa" style="max-width:200px; display:none;"><br>
    <button type="submit">Guardar</button>
  </form>

  <div id="status"></div>

  <!-- Firebase v9 SDKs con sintaxis modular -->
  <script type="module">
    // Importar las funciones necesarias de Firebase
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js';
    import { getFirestore, collection, addDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js';
    import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-storage.js';

    // Configuración de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAn4aEuwIBv21bQK3qfKaUhszVuFeEmJvw",
      authDomain: "viajaralsur.firebaseapp.com",
      projectId: "viajaralsur",
      storageBucket: "viajaralsur.firebasestorage.app",
      messagingSenderId: "927613299224",
      appId: "1:927613299224:web:9ef767c182b20569dff16d",
      measurementId: "G-3CQSZQ04DJ"
    };

    // Inicializar Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // Elementos del formulario y vista previa
    const form = document.getElementById("myForm");
    const status = document.getElementById("status");
    const preview = document.getElementById("preview");
    const imageInput = document.getElementById("image");

    // Previsualizar la imagen seleccionada
    imageInput.addEventListener("change", () => {
      const file = imageInput.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          preview.src = e.target.result;
          preview.style.display = "block";
        };
        reader.readAsDataURL(file);
      } else {
        preview.src = "";
        preview.style.display = "none";
      }
    });

    // Función para mostrar estado
    function mostrarEstado(mensaje, tipo) {
      status.textContent = mensaje;
      status.className = tipo;
    }

    // Manejar envío del formulario
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const name = document.getElementById("name").value;
      const email = document.getElementById("email").value;
      const imageFile = imageInput.files[0];

      if (!imageFile) {
        mostrarEstado("❌ Por favor selecciona una imagen", "error");
        return;
      }

      console.log("Iniciando proceso de subida...");
      console.log("Archivo:", imageFile.name, "Tamaño:", imageFile.size, "bytes");

      mostrarEstado("⏳ Subiendo imagen...", "loading");

      try {
        // Verificar tamaño del archivo (max 5MB)
        if (imageFile.size > 5 * 1024 * 1024) {
          throw new Error("La imagen es demasiado grande. Máximo 5MB.");
        }

        // Subir imagen a Firebase Storage
        const timestamp = Date.now();
        const fileName = `usuarios/${timestamp}_${imageFile.name}`;
        console.log("Subiendo a:", fileName);
        
        const storageRef = ref(storage, fileName);
        
        console.log("Iniciando uploadBytes...");
        const snapshot = await uploadBytes(storageRef, imageFile);
        console.log("Upload completado, obteniendo URL...");
        
        const imageUrl = await getDownloadURL(snapshot.ref);
        console.log("URL obtenida:", imageUrl);

        mostrarEstado("⏳ Guardando datos en Firestore...", "loading");

        // Guardar documento en Firestore
        console.log("Guardando en Firestore...");
        const docRef = await addDoc(collection(db, "usuarios"), {
          nombre: name,
          correo: email,
          fecha: serverTimestamp(),
          imagen: imageUrl
        });
        console.log("Documento guardado con ID:", docRef.id);

        mostrarEstado("✅ Datos y imagen guardados correctamente", "success");
        form.reset();
        preview.src = "";
        preview.style.display = "none";

      } catch (error) {
        console.error("Error completo:", error);
        console.error("Código de error:", error.code);
        console.error("Mensaje:", error.message);
        
        let mensajeError = "Error desconocido";
        if (error.code === 'storage/unauthorized') {
          mensajeError = "Sin permisos para subir archivos. Revisa las reglas de Storage.";
        } else if (error.code === 'permission-denied') {
          mensajeError = "Sin permisos para guardar datos. Revisa las reglas de Firestore.";
        } else if (error.code === 'storage/unknown') {
          mensajeError = "Error de Storage. Verifica la configuración.";
        } else {
          mensajeError = error.message;
        }
        
        mostrarEstado("❌ Error: " + mensajeError, "error");
      }
    });
  </script>
</body>
</html>